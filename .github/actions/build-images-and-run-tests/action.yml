name: Build Images and Run Tests
inputs:
  cfg:
    required: true
    description: "The matrix configuration (generated by a matrix parser)"
  github_token:
    required: true
    description: "The GITHUB_TOKEN stored as a secret, required to push images to ghcr.io"
  CODECOV_TOKEN:
    required: true
    description: "The CODECOV_TOKEN secret used to upload the coverage report to Codecov"
  branch:
    required: true

runs:
  using: composite
  steps:
    - name: Build images
      id: images
      shell: bash
      run: |
        echo "${{ inputs.cfg  }}"
        docker login https://ghcr.io -u ${{ github.actor }} -p ${{ inputs.github_token }}
        i=0; until [ "$i" -ge 3 ]; do
          IMAGES=$(echo '${{ inputs.cfg }}' | DOCKER_BUILDKIT=1 ./tools/test/build_images.py \
              --cache-repo ghcr.io/${{ github.repository }} \
              --branch "${{ inputs.branch }}" ./etc/docker/test || echo "")
          if [[ -n $IMAGES ]]; then break;
          else
            i=$((i+1)); sleep 5;
            echo "::warning::Building images failed, retryingâ€¦"
          fi
        done
        docker logout https://ghcr.io
        if [[ -z "$IMAGES" ]]; then echo "::error::Building images failed ultimately"; exit 1; fi
        echo "images=$IMAGES" >> $GITHUB_OUTPUT
    - name: Run test with cfg
      shell: bash
      run: 'echo ''{"matrix": ${{ inputs.cfg }}, "images": ${{ steps.images.outputs.images }} }'' | ./tools/test/run_tests.py'
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4.0.1
      with:
        token: ${{ inputs.CODECOV_TOKEN }}
